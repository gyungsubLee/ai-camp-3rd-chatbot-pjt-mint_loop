services:
  # Search MCP Server - 키워드 추출 및 검색
  search-mcp:
    build:
      context: .
      dockerfile: Dockerfile.search-mcp
    container_name: search-mcp
    ports:
      - "8050:8050"
    env_file:
      - ../.env
    environment:
      # env_file에서 GEMINI_API_KEY, TAVILY_API_KEY 로드됨
      - MCP_SERVER_PORT=8050
      - DEBUG=${DEBUG:-false}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    restart: unless-stopped
    networks:
      - image-gen-network
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8050/ || exit 0"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # # Image Generation MCP Server - Gemini Imagen 이미지 생성
  # image-mcp:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile.image-mcp
  #   container_name: image-mcp
  #   ports:
  #     - "8051:8051"
  #   env_file:
  #     - ../.env
  #   environment:
  #     # 모든 환경변수는 루트 .env 파일에서 로드됨
  #     - IMAGE_PROVIDER=${IMAGE_PROVIDER}
  #     - GEMINI_IMAGE_MODEL=${GEMINI_IMAGE_MODEL}
  #     - IMAGE_DEFAULT_SIZE=${IMAGE_DEFAULT_SIZE}
  #     - IMAGE_DEFAULT_QUALITY=${IMAGE_DEFAULT_QUALITY}
  #     - IMAGE_DEFAULT_STYLE=${IMAGE_DEFAULT_STYLE}
  #     - MCP_SERVER_PORT=8051
  #     - DEBUG=${DEBUG:-false}
  #     - LOG_LEVEL=${LOG_LEVEL}
  #   restart: unless-stopped
  #   networks:
  #     - image-gen-network
  #   healthcheck:
  #     test: ["CMD-SHELL", "curl -sf http://localhost:8051/ || exit 0"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 3
  #     start_period: 10s
  #   logging:
  #     driver: "json-file"
  #     options:
  #       max-size: "10m"
  #       max-file: "3"

  # Google Places MCP Server - 장소 검색 및 상세 정보
  places-mcp:
    build:
      context: .
      dockerfile: Dockerfile.places-mcp
    container_name: places-mcp
    ports:
      - "8052:8052"
    env_file:
      - ../.env
    environment:
      - MCP_SERVER_PORT=8052
      - DEBUG=${DEBUG:-false}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    restart: unless-stopped
    networks:
      - image-gen-network
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8052/ || exit 0"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Trip Kit API Server - LangGraph Agents
  api-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: tripkit-api-server
    ports:
      - "8000:8000"
    env_file:
      - ../.env
    environment:
      # 모든 환경변수는 루트 .env 파일에서 로드됨
      - GEMINI_TEXT_MODEL=${GEMINI_TEXT_MODEL}
      - GEMINI_IMAGE_MODEL=${GEMINI_IMAGE_MODEL}
      - IMAGE_PROVIDER=${IMAGE_PROVIDER}
      # Recommendation Agent 설정
      - LLM_PROVIDER=${LLM_PROVIDER}
      - LLM_MODEL=${LLM_MODEL}
      - DEBUG=${DEBUG:-false}
      - LOG_LEVEL=${LOG_LEVEL}
      # Vertex AI 설정 (credentials 파일은 volumes로 마운트)
      - GOOGLE_APPLICATION_CREDENTIALS=/app/credentials/vertex-app-key.json
      - VERTEX_PROJECT_ID=${VERTEX_PROJECT_ID}
      - VERTEX_LOCATION=${VERTEX_LOCATION}
    restart: unless-stopped
    networks:
      - image-gen-network
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
      - ${VERTEX_CREDENTIALS_FILE}:/app/credentials/vertex-app-key.json:ro
    command: python -m src.api_server.server
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8000/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  image-gen-network:
    driver: bridge
    name: image-generation-network

volumes:
  agent-data:
    driver: local
  agent-logs:
    driver: local
